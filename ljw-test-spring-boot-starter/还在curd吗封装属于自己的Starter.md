---
theme: qklhk-chocolate
highlight: atom-one-dark
---
# é˜…è¯»æ”¶è·
- ğŸ‘ğŸ»å­¦ä¼šè‡ªå®šä¹‰Starter
- ğŸ‘ğŸ»ç†è§£SpringBootè‡ªåŠ¨é…ç½®åŸç†

# æœ¬ç« æºç ä¸‹è½½
- â¤ï¸[å¼€å‘starter](https://github.com/liangjianweiLJW/java-guide/tree/master/ljw-spring-boot-starter)
- â¤ï¸[æµ‹è¯•starter](https://github.com/liangjianweiLJW/java-guide/tree/master/ljw-test-spring-boot-starter)


# ä»€ä¹ˆæ˜¯Starter
Starteræ˜¯Spring Bootä¸­çš„ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼ŒStarterç›¸å½“äºæ¨¡å—ï¼Œå®ƒèƒ½å°†æ¨¡å—æ‰€éœ€çš„ä¾èµ–æ•´åˆèµ·æ¥å¹¶å¯¹æ¨¡å—å†…çš„Beanæ ¹æ®ç¯å¢ƒï¼ˆ æ¡ä»¶ï¼‰è¿›è¡Œè‡ªåŠ¨é…ç½®ã€‚

**ä½¿ç”¨è€…åªéœ€è¦ä¾èµ–ç›¸åº”åŠŸèƒ½çš„Starterï¼Œæ— éœ€åšè¿‡å¤šçš„é…ç½®å’Œä¾èµ–ï¼ŒSpring Bootå°±èƒ½è‡ªåŠ¨æ‰«æå¹¶åŠ è½½ç›¸åº”çš„æ¨¡å—å¹¶è®¾ç½®é»˜è®¤å€¼ï¼Œåšåˆ°å¼€ç®±å³ç”¨**
# ä¸ºä»€ä¹ˆä½¿ç”¨Starter
åœ¨æˆ‘ä»¬çš„æ—¥å¸¸å¼€å‘å·¥ä½œä¸­ï¼Œç»å¸¸ä¼šæœ‰ä¸€äº›ç‹¬ç«‹äºä¸šåŠ¡ä¹‹å¤–çš„é…ç½®æ¨¡å—ï¼Œæˆ‘ä»¬ç»å¸¸å°†å…¶æ”¾åˆ°ä¸€ä¸ªç‰¹å®šçš„åŒ…ä¸‹ï¼Œç„¶åå¦‚æœå¦ä¸€ä¸ªå·¥ç¨‹éœ€è¦å¤ç”¨è¿™å—åŠŸèƒ½çš„æ—¶å€™ï¼Œéœ€è¦å°†ä»£ç ç¡¬æ‹·è´åˆ°å¦ä¸€ä¸ªå·¥ç¨‹ï¼Œé‡æ–°é›†æˆä¸€éï¼Œéº»çƒ¦è‡³æã€‚

å¦‚æœæˆ‘ä»¬å°†è¿™äº›å¯ç‹¬ç«‹äºä¸šåŠ¡ä»£ç ä¹‹å¤–çš„åŠŸé…ç½®æ¨¡å—å°è£…æˆä¸€ä¸ªä¸ªstarterï¼Œå¹¶åœ¨starterä¸­è®¾ç½®å¥½é»˜è®¤å€¼ï¼Œå¤ç”¨çš„æ—¶å€™åªéœ€è¦å°†å…¶åœ¨pomä¸­å¼•ç”¨ä¾èµ–å³å¯ï¼ŒSpring Bootä¸ºæˆ‘ä»¬å®Œæˆè‡ªåŠ¨è£…é…ï¼Œåšåˆ°`å¼€ç®±å³ç”¨`ã€‚

# Springbootè‡ªåŠ¨é…ç½®
SpringBootä¸­çš„starteræ˜¯ä¸€ç§éå¸¸é‡è¦çš„æœºåˆ¶ï¼Œèƒ½å¤ŸæŠ›å¼ƒä»¥å‰ç¹æ‚çš„é…ç½®ï¼Œå°†å…¶ç»Ÿä¸€é›†æˆè¿›starterï¼Œåº”ç”¨è€…åªéœ€è¦åœ¨mavenä¸­å¼•å…¥starterä¾èµ–ï¼ŒSpring Bootå°±èƒ½è‡ªåŠ¨æ‰«æå„ä¸ªjaråŒ…ä¸‹classpathè·¯å¾„çš„spring.factoriesæ–‡ä»¶ï¼ŒåŠ è½½è‡ªåŠ¨é…ç½®ç±»ä¿¡æ¯ï¼ŒåŠ è½½ç›¸åº”çš„beanä¿¡æ¯å¹¶å¯åŠ¨ç›¸åº”çš„`é»˜è®¤é…ç½®`ã€‚

Spring Bootæä¾›äº†é’ˆå¯¹æ—¥å¸¸ä¼ä¸šåº”ç”¨ç ”å‘å„ç§åœºæ™¯çš„spring-boot-starterä¾èµ–æ¨¡å—ã€‚æ‰€æœ‰è¿™äº›ä¾èµ–æ¨¡å—éƒ½éµå¾ªç€çº¦å®šæˆä¿—çš„é»˜è®¤é…ç½®ï¼Œå¹¶å…è®¸æˆ‘ä»¬è°ƒæ•´è¿™äº›é…ç½®ï¼Œå³éµå¾ªâ€œ`çº¦å®šå¤§äºé…ç½®`â€çš„ç†å¿µã€‚

å¤§å®¶å¯ä»¥çœ‹çœ‹æˆ‘ä¹‹å‰å†™çš„ä¸€ç¯‡æ–‡ç« ï¼Œè¯¦ç»†ä»‹ç»äº†springbootè‡ªåŠ¨é…ç½®çš„æµç¨‹ï¼š[ä¸€æ–‡ææ‡‚ğŸ”¥SpringBootè‡ªåŠ¨é…ç½®åŸç† - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/7046554366068654094)

# spring.factories
Spring Bootä¼šé»˜è®¤æ‰«æè·Ÿå¯åŠ¨ç±»å¹³çº§çš„åŒ…ï¼Œå¦‚æœæˆ‘ä»¬çš„Starterè·Ÿå¯åŠ¨ç±»ä¸åœ¨åŒä¸€ä¸ªä¸»åŒ…ä¸‹ï¼Œéœ€è¦é€šè¿‡é…ç½®spring.factoriesæ–‡ä»¶æ¥é…ç½®ç”Ÿæ•ˆï¼ŒSpringBooté»˜è®¤åŠ è½½å„ä¸ªjaråŒ…ä¸‹classpathè·¯å¾„çš„spring.factoriesæ–‡ä»¶ï¼Œé…ç½®çš„keyä¸º`org.springframework.boot.autoconfigure.EnableAutoConfiguration`

# Starterå¼€å‘å¸¸ç”¨æ³¨è§£
æ³¨è§£ä½¿ç”¨å·²ç»å¤§å¤§æ–¹ä¾¿æˆ‘ä»¬å¼€å‘ï¼Œå†ä¹Ÿä¸éœ€è¦å†™xmlé…ç½®æ–‡ä»¶äº†ï¼ŒSpringBootç»è¿‡æŸ¥æ‰¾spring.factoriesæ–‡ä»¶ï¼ŒåŠ è½½è‡ªåŠ¨é…ç½®ç±»ï¼Œè€Œè‡ªåŠ¨é…ç½®ç±»ä¸­å®šä¹‰äº†å„ç§è¿è¡Œæ—¶åˆ¤æ–­æ¡ä»¶ï¼Œå¦‚@ConditionalOnMissingBean(A.class)ç­‰ï¼Œåªè¦iocå®¹å™¨ä¸­æ²¡æœ‰æŒ‡å®šçš„Aç±»å‹çš„beanä¿¡æ¯ï¼Œè¯¥é…ç½®æ–‡ä»¶æ‰ä¼šç”Ÿæ•ˆã€‚

@Conditionalæ˜¯Spring4æ–°æä¾›çš„æ³¨è§£ï¼Œå®ƒçš„ä½œç”¨æ˜¯æŒ‰ç…§ä¸€å®šçš„æ¡ä»¶è¿›è¡Œåˆ¤æ–­ï¼Œæ»¡è¶³æ¡ä»¶ç»™å®¹å™¨æ³¨å†Œbeanã€‚

- å±æ€§æ˜ å°„æ³¨è§£
    - @ConfigurationProperties ï¼šé…ç½®æ–‡ä»¶å±æ€§å€¼å’Œå®ä½“ç±»çš„æ˜ å°„
    - @EnableConfigurationPropertiesï¼šå’Œ@ConfigurationPropertiesé…åˆä½¿ç”¨ï¼ŒæŠŠ@ConfigurationPropertiesä¿®é¥°çš„ç±»åŠ å…¥iocå®¹å™¨ã€‚
- é…ç½®beanæ³¨è§£
    - @Configuration ï¼šæ ‡è¯†è¯¥ç±»ä¸ºé…ç½®ç±»ï¼Œå¹¶æŠŠè¯¥ç±»æ³¨å…¥iocå®¹å™¨
    - @Bean ï¼šä¸€èˆ¬åœ¨æ–¹æ³•ä¸Šä½¿ç”¨ï¼Œå£°æ˜ä¸€ä¸ªbeanï¼Œbeanåç§°é»˜è®¤æ˜¯æ–¹æ³•åç§°ï¼Œç±»å‹ä¸ºè¿”å›å€¼ã€‚
- æ¡ä»¶æ³¨è§£
    - @Conditionalï¼šæ˜¯æ ¹æ®æ¡ä»¶ç±»åˆ›å»ºç‰¹å®šçš„Beanï¼Œæ¡ä»¶ç±»éœ€è¦å®ç°Conditionæ¥å£ï¼Œå¹¶é‡å†™matchesæ¥å£æ¥æ„é€ åˆ¤æ–­æ¡ä»¶ã€‚
    - @ConditionalOnBean ï¼šå®¹å™¨ä¸­å­˜åœ¨æŒ‡å®šbeanï¼Œæ‰ä¼šå®ä¾‹åŒ–ä¸€ä¸ªBean
    - @ConditionalOnMissingBeanï¼šå®¹å™¨ä¸­ä¸å­˜åœ¨æŒ‡å®šbeanï¼Œæ‰ä¼šå®ä¾‹åŒ–ä¸€ä¸ªBean
    - @ConditionalOnClassï¼šç³»ç»Ÿä¸­æœ‰æŒ‡å®šç±»ï¼Œæ‰ä¼šå®ä¾‹åŒ–ä¸€ä¸ªBean
    - @ConditionalOnMissingClassï¼šç³»ç»Ÿä¸­æ²¡æœ‰æŒ‡å®šç±»ï¼Œæ‰ä¼šå®ä¾‹åŒ–ä¸€ä¸ªBean
    - @ConditionalOnExpressionï¼šå½“SpElè¡¨è¾¾å¼ä¸ºtrueçš„æ—¶å€™ï¼Œæ‰ä¼šå®ä¾‹åŒ–ä¸€ä¸ªBean
    - @AutoConfigureAfter ï¼šåœ¨æŸä¸ªbeanå®Œæˆè‡ªåŠ¨é…ç½®åå®ä¾‹åŒ–è¿™ä¸ªbean
    - @AutoConfigureBefore ï¼šåœ¨æŸä¸ªbeanå®Œæˆè‡ªåŠ¨é…ç½®å‰å®ä¾‹åŒ–è¿™ä¸ªbean
    - @ConditionalOnJava ï¼šç³»ç»Ÿä¸­ç‰ˆæœ¬æ˜¯å¦ç¬¦åˆè¦æ±‚
    - @ConditionalOnSingleCandidateï¼šå½“æŒ‡å®šçš„Beanåœ¨å®¹å™¨ä¸­åªæœ‰ä¸€ä¸ªï¼Œæˆ–è€…æœ‰å¤šä¸ªä½†æ˜¯æŒ‡å®šäº†é¦–é€‰çš„Beanæ—¶è§¦å‘å®ä¾‹åŒ–
    - @ConditionalOnResourceï¼šç±»è·¯å¾„ä¸‹æ˜¯å¦å­˜åœ¨æŒ‡å®šèµ„æºæ–‡ä»¶
    - @ConditionalOnWebApplicationï¼šæ˜¯webåº”ç”¨
    - @ConditionalOnNotWebApplicationï¼šä¸æ˜¯webåº”ç”¨
    - @ConditionalOnJndiï¼šJNDIæŒ‡å®šå­˜åœ¨é¡¹
    - @ConditionalOnPropertyï¼š é…ç½®Configurationçš„åŠ è½½è§„åˆ™
        -   prefix ï¼šé…ç½®å±æ€§åç§°çš„å‰ç¼€
        -   value ï¼šæ•°ç»„ï¼Œè·å–å¯¹åº”propertyåç§°çš„å€¼ï¼Œä¸nameä¸å¯åŒæ—¶ä½¿ç”¨
        -   name ï¼šæ•°ç»„ï¼Œå¯ä¸prefixç»„åˆä½¿ç”¨ï¼Œç»„æˆå®Œæ•´çš„é…ç½®å±æ€§åç§°ï¼Œä¸valueä¸å¯åŒæ—¶ä½¿ç”¨
        -   havingValue  ï¼šæ¯”è¾ƒè·å–åˆ°çš„å±æ€§å€¼ä¸havingValueç»™å®šçš„å€¼æ˜¯å¦ç›¸åŒï¼Œç›¸åŒæ‰åŠ è½½é…ç½®
        -   matchIfMissing ï¼šç¼ºå°‘è¯¥é…ç½®å±æ€§æ—¶æ˜¯å¦å¯ä»¥åŠ è½½ã€‚å¦‚æœä¸ºtrueï¼Œæ²¡æœ‰è¯¥é…ç½®å±æ€§æ—¶ä¹Ÿä¼šæ­£å¸¸åŠ è½½ï¼›åä¹‹åˆ™ä¸ä¼šç”Ÿæ•ˆ

# Fullå…¨æ¨¡å¼å’ŒLiteè½»é‡çº§æ¨¡å¼
- @Configurationå‚æ•°proxyBeanMethodsï¼š
    - Full å…¨æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ï¼š`@Configuration(proxyBeanMethods = true)`
        - åŒä¸€é…ç½®ç±»ä¸‹ï¼Œå½“ç›´æ¥è°ƒç”¨@Beanä¿®é¥°çš„`æ–¹æ³•`æ³¨å…¥çš„å¯¹è±¡ï¼Œåˆ™è°ƒç”¨`è¯¥æ–¹æ³•ä¼šè¢«ä»£ç†`ï¼Œä»iocå®¹å™¨ä¸­å–beanå®åˆ—ï¼Œæ‰€ä»¥å®åˆ—æ˜¯ä¸€æ ·çš„ã€‚å³å•å®ä¾‹å¯¹è±¡ï¼Œåœ¨è¯¥æ¨¡å¼ä¸‹SpringBootæ¯æ¬¡å¯åŠ¨éƒ½ä¼šåˆ¤æ–­æ£€æŸ¥å®¹å™¨ä¸­æ˜¯å¦å­˜åœ¨è¯¥ç»„ä»¶
    - Lite è½»é‡çº§æ¨¡å¼ï¼š`@Configuration(proxyBeanMethods = false)`
        - åŒä¸€é…ç½®ç±»ä¸‹ï¼Œå½“ç›´æ¥è°ƒç”¨@Beanä¿®é¥°çš„`æ–¹æ³•`æ³¨å…¥çš„å¯¹è±¡ï¼Œåˆ™è°ƒç”¨`è¯¥æ–¹æ³•ä¸ä¼šè¢«ä»£ç†`ï¼Œç›¸å½“äºç›´æ¥è°ƒç”¨ä¸€ä¸ªæ™®é€šæ–¹æ³•ï¼Œä¼šæœ‰æ„é€ æ–¹æ³•ï¼Œä½†æ˜¯æ²¡æœ‰beançš„ç”Ÿå‘½å‘¨æœŸï¼Œè¿”å›çš„æ˜¯ä¸åŒçš„å®ä¾‹ã€‚
- æ³¨ï¼šproxyBeanMethods æ˜¯ä¸ºäº†è®©ä½¿ç”¨@Beanæ³¨è§£çš„`æ–¹æ³•`è¢«ä»£ç†ã€‚è€Œä¸æ˜¯@Beançš„å•ä¾‹å¤šä¾‹çš„è®¾ç½®å‚æ•°ã€‚
- æµ‹è¯•ä¾‹å­è¿™é‡Œä¸å±•ç¤ºï¼Œå¯ä»¥ä¸‹è½½æˆ‘çš„ä»£ç æŸ¥çœ‹
```java
@Configuration(proxyBeanMethods = false)
public class AppConfig {
    
    //æ”¾ä¸€ä»½myBeanåˆ°iocå®¹å™¨
    @Bean
    public Mybean myBean() {
        return new Mybean();
    }

    //æ”¾ä¸€ä»½yourBeanåˆ°iocå®¹å™¨
    @Bean
    public YourBean yourBean() {
        System.out.println("==========");
        //æ³¨æ„ï¼š@Configuration(proxyBeanMethods = false)ï¼šmyBean()æ–¹æ³•ä¸ä»£ç†ï¼Œç›´æ¥è°ƒç”¨
        //æ³¨æ„ï¼š@Configuration(proxyBeanMethods = true)ï¼šmyBean()æ–¹æ³•ä»£ç†ï¼Œä»iocå®¹å™¨æ‹¿
        return new YourBean(myBean());
    }
}
```

ä»€ä¹ˆæ—¶å€™ç”¨Fullå…¨æ¨¡å¼ï¼Œä»€ä¹ˆæ—¶å€™ç”¨Liteè½»é‡çº§æ¨¡å¼ï¼Ÿ

- å½“åœ¨ä½ çš„åŒä¸€ä¸ªConfigurationé…ç½®ç±»ä¸­ï¼Œæ³¨å…¥åˆ°å®¹å™¨ä¸­çš„beanå®ä¾‹ä¹‹é—´æœ‰ä¾èµ–å…³ç³»æ—¶ï¼Œå»ºè®®ä½¿ç”¨Fullå…¨æ¨¡å¼
- å½“åœ¨ä½ çš„åŒä¸€ä¸ªConfigurationé…ç½®ç±»ä¸­ï¼Œæ³¨å…¥åˆ°å®¹å™¨ä¸­çš„beanå®ä¾‹ä¹‹é—´æ²¡æœ‰ä¾èµ–å…³ç³»æ—¶ï¼Œå»ºè®®ä½¿ç”¨Liteè½»é‡çº§æ¨¡å¼ï¼Œä»¥æé«˜springbootçš„å¯åŠ¨é€Ÿåº¦å’Œæ€§èƒ½


# Starterå‘½åè§„èŒƒ
- Springå®˜æ–¹Starteré€šå¸¸å‘½åä¸ºspring-boot-starter-{name}å¦‚ï¼šspring-boot-starter-web
- Springå®˜æ–¹å»ºè®®éå®˜æ–¹Starterå‘½ååº”éµå¾ª{name}-spring-boot-starterçš„æ ¼å¼ï¼šå¦‚mybatis-spring-boot-starterã€‚

# å¼€å‘Starter
## 1. åˆ›å»ºStarteré¡¹ç›®
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/43de8bfad0a54af9961945435fee4a64~tplv-k3u1fbpfcp-watermark.image?)
- `æ–°å»ºé¡¹ç›®åï¼Œè¦åˆ é™¤mainå¯åŠ¨ç±»`

## 2. æ·»åŠ ä¾èµ–
```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.6.1</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>

    <modelVersion>4.0.0</modelVersion>
    <groupId>com.ljw</groupId>
    <artifactId>ljw-spring-boot-starter</artifactId>
    <version>1.0</version>
    
   <properties>
        <java.version>1.8</java.version>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
    </properties>


    <dependencies>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter</artifactId>
        </dependency>

        <!--        åŒ…å«è‡ªåŠ¨é…ç½®çš„ä»£ç -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-autoconfigure</artifactId>
        </dependency>

        <!--        é…ç½®æ–‡ä»¶ç‚¹å‡»å¯ä»¥è·³è½¬å®ä½“-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-configuration-processor</artifactId>
            <optional>true</optional>
        </dependency>

    </dependencies>

</project>
```
- `æˆ‘ä»¬æ²¡æœ‰mainå…¥å£ï¼Œéœ€è¦å»é™¤pomæ–‡ä»¶ä¸­mavenæ‰“åŒ…æ’ä»¶spring-boot-maven-plugin`
- spring-boot-configuration-processorä½œç”¨ï¼š
    - spring-boot-configuration-processorå…¶å®æ˜¯ä¸€ä¸ªæ³¨è§£å¤„ç†å™¨ï¼Œåœ¨ç¼–è¯‘é˜¶æ®µå¹²æ´»çš„ï¼Œä¸€èˆ¬åœ¨mavençš„å£°æ˜éƒ½æ˜¯optional ä¸ºtrue
    - ä½ åœ¨ideaé‡Œé¢å¯ä»¥ç‚¹å‡»portï¼Œè¿›åˆ°è¿™ä¸ªå­—æ®µé‡Œé¢ï¼Œè¿˜å¯ä»¥çœ‹åˆ°é…ç½®çš„æç¤ºä¿¡æ¯
    - è¿™æ˜¯å› ä¸ºåœ¨ä½ çš„èµ„æºæ–‡ä»¶é‡Œé¢æœ‰ä¸€ä¸ªspring-configuration-metadata.jsonæ–‡ä»¶ï¼Œè¿™æ˜¯springé…ç½®çš„å…ƒæ•°æ®ï¼Œæ˜¯jsonå½¢å¼

## 3. ç¼–å†™å±æ€§ç±»
@ConfigurationPropertieså¯ä»¥å®šä¹‰ä¸€ä¸ªé…ç½®ä¿¡æ¯ç±»ï¼Œå’Œé…ç½®æ–‡ä»¶è¿›è¡Œæ˜ å°„

```java
@ConfigurationProperties(prefix = "ljw.config")
public class HelloProperties {

    private String name = "hello é»˜è®¤å€¼ï¼";

    private int age = 8;

    public int getAge() {
        return age;
    }

    public void setAge(int age) {
        this.age = age;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }
}
```

## 4. è‡ªå®šä¹‰ä¸šåŠ¡ç±»
è¿™é‡Œå¯ä»¥æ¨¡æ‹Ÿä¸€äº›è·å–äº†é…ç½®æ–‡ä»¶ä¿¡æ¯çš„è¿›è¡Œä¸šåŠ¡æ“ä½œçš„ä¸šåŠ¡ç±»
```java
public class HelloService {

    private String name;

    private int age;

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public int getAge() {
        return age;
    }

    public void setAge(int age) {
        this.age = age;
    }

    public String hello() {
        return "HelloService{" +
                "name='" + name + ''' +
                ", age=" + age +
                '}';
    }
}
```

## 5. ç¼–å†™è‡ªåŠ¨é…ç½®ç±»
å‘½åè§„èŒƒï¼šXxxAutoConfiguration
```java
@Configuration(proxyBeanMethods = false)
// å½“å­˜åœ¨æŸä¸ªç±»æ—¶ï¼Œæ­¤è‡ªåŠ¨é…ç½®ç±»æ‰ä¼šç”Ÿæ•ˆ
@ConditionalOnClass(value = {HelloService.class})
// å¯¼å…¥æˆ‘ä»¬è‡ªå®šä¹‰çš„é…ç½®ç±»,ä¾›å½“å‰ç±»ä½¿ç”¨
@EnableConfigurationProperties(value = HelloProperties.class)
// åªæœ‰éwebåº”ç”¨ç¨‹åºæ—¶æ­¤è‡ªåŠ¨é…ç½®ç±»æ‰ä¼šç”Ÿæ•ˆ
@ConditionalOnWebApplication
//åˆ¤æ–­ljw.config.flagçš„å€¼æ˜¯å¦ä¸ºâ€œtrueâ€ï¼Œ matchIfMissing = trueï¼šæ²¡æœ‰è¯¥é…ç½®å±æ€§æ—¶ä¹Ÿä¼šæ­£å¸¸åŠ è½½
@ConditionalOnProperty(prefix = "ljw.config", name = "flag", havingValue = "true", matchIfMissing = true)
public class HelloAutoConfiguration {

    /**
     * @param helloProperties ç›´æ¥æ–¹æ³•ç­¾åå…¥å‚æ³¨å…¥HelloProperties,ä¹Ÿå¯ä»¥ä½¿ç”¨å±æ€§æ³¨å…¥
     * @return
     */
    @Bean
    @ConditionalOnMissingBean(HelloService.class)
    //@ConditionalOnProperty(prefix = "ljw.config", name = "flag", havingValue = "true", matchIfMissing = true)
    public HelloService helloService(HelloProperties helloProperties) {
        HelloService helloService = new HelloService();
        //æŠŠè·å–çš„ä¿¡æ¯æ³¨å…¥
        helloService.setName(helloProperties.getName());
        helloService.setAge(helloProperties.getAge());
        return helloService;
    }

}
```
æ³¨ï¼šè¿™é‡Œé…ç½®ä¸€ä¸ªwebåº”ç”¨æ‰èƒ½æ³¨å…¥ï¼Œå¹¶ä¸”ljw.config.flagçš„å€¼æ˜¯å¦ä¸ºâ€œtrueâ€æˆ–è€…ä¸é…ç½®è¯¥keyæ‰èƒ½æ³¨å…¥HelloServiceæœåŠ¡


## 6. ç¼–å†™spring.factories
æŠŠè‡ªåŠ¨é…ç½®ç±»HelloAutoConfigurationé…ç½®åˆ°org.springframework.boot.autoconfigure.EnableAutoConfigurationçš„keyä¸‹ï¼Œspringbootä¼šè‡ªåŠ¨åŠ è½½è¯¥æ–‡ä»¶å¹¶æ ¹æ®æ¡ä»¶è£…é…
```factories
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
com.ljw.starter.config.HelloAutoConfiguration
```

## 7. ç¼–å†™é…ç½®æç¤ºæ–‡ä»¶ï¼ˆéå¿…é¡»ï¼‰
### additional-spring-configuration-metadata.json
é…ç½®additional-spring-configuration-metadata.jsonæ–‡ä»¶åï¼Œåœ¨å¼€å‘äººå‘˜çš„IDEå·¥å…·ä½¿ç”¨ä¸ªäººç¼–å†™çš„é…ç½®è¯»å–å¾ˆæœ‰æ•ˆçš„åœ¨`application.properties`æˆ–`application.yml`æ–‡ä»¶ä¸‹å®Œæˆæç¤ºã€‚

[é…ç½®è¯¦ç»†æ ¼å¼å‚æ•°å¯æŸ¥çœ‹æ–‡æ¡£](https://docs.spring.io/spring-boot/docs/2.1.7.RELEASE/reference/html/configuration-metadata.html#configuration-metadata-format)

æˆ‘çš„é…ç½®ï¼š
```json
{"properties": [
    {
      "name": "ljw.config.name",
      "type": "java.lang.String",
      "defaultValue": "hello é»˜è®¤å€¼ï¼è¿™é‡Œé…ç½®çš„æ˜¯æç¤ºï¼ŒçœŸæ­£é»˜è®¤å€¼åœ¨Propertiesé‡Œé¢",
      "description": "è¿™æ˜¯å­—ç¬¦ä¸²åç§°å•Š."
    },
    {
      "name": "ljw.config.age",
      "defaultValue": 8,
      "description": "è¿™æ˜¯intç±»å‹çš„å¹´é¾„å•Š.",
      "deprecation": {
              "reason": "è¿‡æ—¶åŸå› .",
              "replacement": "æ›¿ä»£keyæ˜¯ï¼šljw.config.age22",
              "level": "warning"
            }
    }
]}
```

å¤§å®¶å‚è€ƒä¸‹é¢`properties`è¡¨æ ¼è¿›è¡Œé…ç½®ä¸Šçš„ç†è§£ã€‚

| åç§°           | ç±»å‹     | ç›®çš„  |
| ------------ | ------ | ------------ |
| name         | String | å±æ€§çš„å…¨åã€‚åç§°é‡‡ç”¨å°å†™çš„å‘¨æœŸåˆ†éš”å½¢å¼(ä¾‹å¦‚server.address)ã€‚æ­¤å±æ€§æ˜¯å¼ºåˆ¶æ€§çš„ã€‚
| type         | String | å±æ€§çš„æ•°æ®ç±»å‹çš„å®Œæ•´ç­¾åï¼ˆä¾‹å¦‚java.lang.Stringï¼‰ï¼Œä½†ä¹Ÿæ˜¯å®Œæ•´çš„æ³›å‹ç±»å‹ï¼ˆä¾‹å¦‚java.util.Map<java.util.String,acme.MyEnum>ï¼‰ã€‚æ‚¨å¯ä»¥ä½¿ç”¨æ­¤å±æ€§æ¥æŒ‡å¯¼ç”¨æˆ·å¯ä»¥è¾“å…¥çš„å€¼çš„ç±»å‹ã€‚ä¸ºäº†ä¿æŒä¸€è‡´æ€§ï¼Œé€šè¿‡ä½¿ç”¨å…¶åŒ…è£…å¯¹åº”é¡¹ï¼ˆä¾‹å¦‚ï¼Œbooleanå˜ä¸ºjava.lang.Booleanï¼‰æ¥æŒ‡å®šåŸºå…ƒçš„ç±»å‹ã€‚è¯·æ³¨æ„ï¼Œæ­¤ç±»å¯èƒ½æ˜¯ä¸€ä¸ªå¤æ‚ç±»å‹ï¼Œå®ƒä»Stringasç»‘å®šçš„å€¼è½¬æ¢è€Œæ¥ã€‚`å¦‚æœç±»å‹æœªçŸ¥æˆ–åŸºæœ¬ç±»å‹ï¼Œåˆ™å¯ä»¥çœç•¥ã€‚` |
| description  | String | å¯ä»¥å‘ç”¨æˆ·æ˜¾ç¤ºçš„ç»„çš„ç®€çŸ­æè¿°ã€‚å¦‚æœæ²¡æœ‰å¯ç”¨çš„æè¿°ï¼Œåˆ™å¯ä»¥çœç•¥ã€‚å»ºè®®æè¿°ä¸ºç®€çŸ­æ®µè½ï¼Œç¬¬ä¸€è¡Œæä¾›ç®€æ˜æ‘˜è¦ã€‚æè¿°ä¸­çš„æœ€åä¸€è¡Œåº”ä»¥å¥ç‚¹ï¼ˆ.ï¼‰ç»“å°¾ã€‚|
| sourceType   | String | è´¡çŒ®æ­¤å±æ€§çš„æºçš„ç±»åç§°ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå±æ€§æ¥è‡ªå¸¦æ³¨é‡Šçš„ç±»@ConfigurationPropertiesï¼Œåˆ™æ­¤å±æ€§å°†åŒ…å«è¯¥ç±»çš„å®Œå…¨é™å®šåç§°ã€‚å¦‚æœæºç±»å‹æœªçŸ¥ï¼Œåˆ™å¯ä»¥çœç•¥ã€‚|
| defaultValue | Object | é»˜è®¤å€¼ï¼Œå¦‚æœæœªæŒ‡å®šå±æ€§ï¼Œåˆ™ä½¿ç”¨è¯¥å€¼ã€‚å¦‚æœå±æ€§çš„ç±»å‹æ˜¯æ•°ç»„ï¼Œåˆ™å®ƒå¯ä»¥æ˜¯å€¼æ•°ç»„ã€‚å¦‚æœé»˜è®¤å€¼æœªçŸ¥ï¼Œåˆ™å¯ä»¥çœç•¥ã€‚|
| deprecation | æ•°ç»„ | è¿‡æ—¶çš„æè¿°ã€‚|


`deprecation`æ¯ä¸ª`properties`å…ƒç´ çš„å±æ€§ä¸­åŒ…å«çš„JSONå¯¹è±¡å¯ä»¥åŒ…å«ä»¥ä¸‹å±æ€§ï¼š

| åç§°  | ç±»å‹    | ç›®çš„    |
| ---------- | ------ | --------- |
| level       | String | å¼ƒç”¨çº§åˆ«ï¼Œå¯ä»¥æ˜¯warningï¼ˆé»˜è®¤ï¼‰æˆ–errorã€‚å½“å±æ€§å…·æœ‰warningå¼ƒç”¨çº§åˆ«æ—¶ï¼Œå®ƒä»åº”ç»‘å®šåœ¨ç¯å¢ƒä¸­ã€‚ä½†æ˜¯ï¼Œå½“å®ƒå…·æœ‰errorå¼ƒç”¨çº§åˆ«æ—¶ï¼Œè¯¥å±æ€§ä¸å†å—ç®¡ç†ä¸”ä¸å—çº¦æŸã€‚ |
| reason      | String | è¯¥å±æ€§è¢«å¼ƒç”¨çš„åŸå› çš„ç®€çŸ­æè¿°ã€‚å¦‚æœæ²¡æœ‰å¯ç”¨çš„åŸå› ï¼Œå¯ä»¥çœç•¥ã€‚å»ºè®®æè¿°ä¸ºç®€çŸ­æ®µè½ï¼Œç¬¬ä¸€è¡Œæä¾›ç®€æ˜æ‘˜è¦ã€‚æè¿°ä¸­çš„æœ€åä¸€è¡Œåº”ä»¥å¥ç‚¹ï¼ˆ.ï¼‰ç»“å°¾ã€‚|
| replacement | String | æ›¿æ¢æ­¤ä¸æ¨èä½¿ç”¨çš„å±æ€§çš„å±æ€§çš„å…¨åã€‚å¦‚æœæ­¤å±æ€§æ²¡æœ‰æ›¿æ¢ï¼Œåˆ™å¯ä»¥çœç•¥ã€‚|

### spring-configuration-metadata.json
spring-configuration-metadata.jsonä»£ç é‡æŒºå¤§çš„ï¼Œä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬å¯ä»¥é€šè¿‡IDEæ¥ç”Ÿæˆï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ideaã€‚

**åœ¨ideaè®¾ç½®ä¸­æœç´¢Annotation Processorsï¼Œæ¥ä¸‹æ¥å‹¾ä½Enable annonation processingå°±å®Œæˆäº†ã€‚
åœ¨ç¼–è¯‘æ‰“åŒ…åçš„æ–‡ä»¶ä¸­çœ‹åˆ°è‡ªåŠ¨ç”Ÿæˆçš„spring-configuration-metadata.jsonã€‚è¿™ä¸ªæ–‡ä»¶ä¸ç”¨æˆ‘ä»¬ç¼–å†™**

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eecc0f2c3eae45508f65a6584bdd3bb5~tplv-k3u1fbpfcp-watermark.image?)

ä¸‹é¢æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼š
```json
{
  "groups": [
    {
      "name": "ljw.config",
      "type": "com.ljw.starter.properties.HelloProperties",
      "sourceType": "com.ljw.starter.properties.HelloProperties"
    }
  ],
  "properties": [
    {
      "name": "ljw.config.name",
      "type": "java.lang.String",
      "description": "è¿™æ˜¯å­—ç¬¦ä¸²åç§°å•Š.",
      "sourceType": "com.ljw.starter.properties.HelloProperties",
      "defaultValue": "hello é»˜è®¤å€¼ï¼è¿™é‡Œé…ç½®çš„æ˜¯æç¤ºï¼ŒçœŸæ­£é»˜è®¤å€¼åœ¨Propertiesé‡Œé¢"
    },
    {
      "name": "ljw.config.age",
      "type": "java.lang.Integer",
      "description": "è¿™æ˜¯intç±»å‹çš„å¹´é¾„å•Š.",
      "sourceType": "com.ljw.starter.properties.HelloProperties",
      "defaultValue": 8,
      "deprecated": true,
      "deprecation": {
        "level": "warning",
        "reason": "è¿‡æ—¶åŸå› .",
        "replacement": "æ›¿ä»£keyæ˜¯ï¼šljw.config.age22"
      }
    }
  ],
  "hints": []
}
```

# æµ‹è¯•Starter
## 1. å‰ç½®ç¯å¢ƒ
æ‰“åŒ…è‡ªå®šä¹‰starteré¡¹ç›®ï¼š[ljw-spring-boot-starter](https://github.com/liangjianweiLJW/java-guide/tree/master/ljw-spring-boot-starter)

æ–°å»ºé¡¹ç›®ï¼š[ljw-test-spring-boot-starter](https://github.com/liangjianweiLJW/java-guide/tree/master/ljw-test-spring-boot-starter)

## 2. æ·»åŠ ä¾èµ–
```xml
<dependencies>
        
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter</artifactId>
    </dependency>
    <!--        æµ‹è¯•webåº”ç”¨-->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <!--è‡ªå®šä¹‰satrter-->
    <dependency>
        <groupId>com.ljw</groupId>
        <artifactId>ljw-spring-boot-starter</artifactId>
        <version>1.0</version>
    </dependency>
</dependencies>
```
## 3. æµ‹è¯•ç±»
```java
@Service
public class TestController implements CommandLineRunner {

    /**
     * æ³¨å…¥è‡ªå®šä¹‰starteræœåŠ¡
     */
    @Resource
    private HelloService helloService;

    @Override
    public void run(String... args) throws Exception {
        System.out.println(helloService.hello());
    }
}
```

## 4. ä¿®æ”¹é…ç½®æ–‡ä»¶
è¾“å…¥å‰ç¼€å¯ä»¥çœ‹å‡ºå·²ç»æœ‰æç¤ºäº†

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d8cc11a5bcca440fb2073c0764ebb886~tplv-k3u1fbpfcp-watermark.image?)

```properties
ljw.config.name=ljw hello!
ljw.config.age=99
ljw.config.flag=true
#ä¸ä¼šæ³¨å…¥
#ljw.config.flag=true1
# å¯ä»¥çœ‹åˆ°å“ªäº›è‡ªåŠ¨é…ç½®äº†
debug=true
```
## 5. è¿è¡Œç¨‹åºæ‰“å°

```console
HelloService{name='ljw hello!', age=99}
```
- æ¡ä»¶æ³¨å…¥
    - å¦‚æœæ²¡æœ‰spring-boot-starter-webä¾èµ–ï¼Œä¸èƒ½æ³¨å…¥æœåŠ¡HelloService
    - å¦‚æœé…ç½®äº†ljw.config.flagï¼Œå€¼ä¸æ˜¯trueï¼Œä¸èƒ½æ³¨å…¥æœåŠ¡HelloServiceï¼›å¦‚æœä¸é…ç½®ljw.config.flagï¼Œå¯ä»¥æ³¨å…¥

## 6. æŸ¥çœ‹è‡ªåŠ¨é…ç½®ç±»ç”Ÿæ•ˆçš„æ–¹æ³•
é€šè¿‡å¯ç”¨ debug=true å±æ€§ï¼Œè®©æ§åˆ¶å°æ‰“å°è‡ªåŠ¨é…ç½®æŠ¥å‘Šï¼Œè¿™æ ·å°±å¯ä»¥å¾ˆæ–¹ä¾¿åœ°çŸ¥é“å“ªäº›è‡ªåŠ¨é…ç½®ç±»ç”Ÿæ•ˆã€‚

```js
   HelloAutoConfiguration matched:
      - @ConditionalOnClass found required class 'com.ljw.starter.service.HelloService' (OnClassCondition)
      - @ConditionalOnWebApplication (required) found 'session' scope (OnWebApplicationCondition)
      - @ConditionalOnProperty (ljw.config.flag=true) matched (OnPropertyCondition)

   HelloAutoConfiguration#helloService matched:
      - @ConditionalOnMissingBean (types: com.ljw.starter.service.HelloService; SearchStrategy: all) did not find any beans (OnBeanCondition)
```


- ğŸ‘ğŸ»ï¼šæœ‰æ”¶è·çš„ï¼Œç‚¹èµé¼“åŠ±ï¼
- â¤ï¸ï¼šæ”¶è—æ–‡ç« ï¼Œæ–¹ä¾¿å›çœ‹ï¼
- ğŸ’¬ï¼šè¯„è®ºäº¤æµï¼Œäº’ç›¸è¿›æ­¥ï¼
